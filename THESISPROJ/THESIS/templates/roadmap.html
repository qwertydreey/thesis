<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roadmap</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/roadmap.css') }}" />
</head>
<body>
  <div class="roadmap-wrapper">
    <div class="roadmap-content">
      <!-- Background Image -->
      <img src="{{ url_for('static', filename='images/gameimg/roadmap/roadmap.png') }}" alt="Roadmap" class="bg-img" />

      <!-- Image-Based Buttons -->
      <div class="roadmap-buttons">
        <!-- Back Button -->
        <div class="roadmap-btn-wrapper">
          <a href="{{ url_for('dashboard') }}">
            <button class="back-btn"></button>
          </a>
        </div>

        <!-- Map Buttons and Stars -->
        {% set maps = [
          ('addition', 'addition-village'),
          ('subtraction', 'subtraction-sands'),
          ('comparison', 'comparison-cliffs'),
          ('placevalue', 'place-value-town'),
          ('multiplication', 'multiplication-mirage'),
          ('division', 'division-river'),
          ('numerals', 'numeral-ruins'),
          ('counting', 'counting-springs')
        ] %}

        {% for map, class_name in maps %}
        <div class="roadmap-btn-wrapper">
          <a href="{{ url_for('stages', map=map) }}" class="roadmap-btn {{ class_name }}" data-map="{{ map }}"></a>
        </div>
        <div class="star-wrapper {{ class_name }}-stars">
          <img src="{{ url_for('static', filename='images/gameimg/roadmap/star-empty.png') }}" class="progress-star star-1" alt="star">
          <img src="{{ url_for('static', filename='images/gameimg/roadmap/star-empty.png') }}" class="progress-star star-2" alt="star">
          <img src="{{ url_for('static', filename='images/gameimg/roadmap/star-empty.png') }}" class="progress-star star-3" alt="star">
        </div>
        {% endfor %}
      </div> <!-- .roadmap-buttons -->
    </div> <!-- .roadmap-content -->
  </div> <!-- .roadmap-wrapper -->

<!-- STAR PROGRESS SCRIPT -->
<script>
  const starFilled = "{{ url_for('static', filename='images/gameimg/roadmap/star-filled.png') }}";
  const starEmpty = "{{ url_for('static', filename='images/gameimg/roadmap/star-empty.png') }}";

  async function fetchUserProgress() {
    try {
      const response = await fetch("/api/user_progress");
      const data = await response.json();
      return data;
    } catch (err) {
      console.error("Failed to load user progress:", err);
      return {};
    }
  }

  function setStars(wrapperSelector, starsCount) {
    const wrapper = document.querySelector(wrapperSelector);
    const stars = wrapper.querySelectorAll('.progress-star');
    for (let i = 0; i < stars.length; i++) {
      stars[i].src = i < starsCount ? starFilled : starEmpty;
    }
  }

  async function updateAllStars() {
    const progress = await fetchUserProgress();

    const maps = [
      ['addition', 'addition-village-stars'],
      ['subtraction', 'subtraction-sands-stars'],
      ['comparison', 'comparison-cliffs-stars'],
      ['placevalue', 'place-value-town-stars'],
      ['multiplication', 'multiplication-mirage-stars'],
      ['division', 'division-river-stars'],
      ['numerals', 'numeral-ruins-stars'],
      ['counting', 'counting-springs-stars']
    ];

    maps.forEach(([mapKey, wrapperClass]) => {
      const stars = progress[mapKey] || 0;
      setStars(`.${wrapperClass}`, stars);
    });
  }

  updateAllStars();
</script>
</body>
</html>