<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stages</title>
  <!-- Link to External CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/stages.css') }}" />
  <!-- Tailwind CSS (Optional) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div class="back">
    <a href="{{ url_for('roadmap') }}">
      <button class="back-btn"></button>
    </a>
  </div>
  
  <div class="main-wrapper">
    <div class="stages-content">
      <img src="{{ url_for('static', filename='images/stageimg/bg.png') }}" alt="stages" class="bg-img" />
    </div>
    <div class="map-img">
      <div class="buttons">
        <button class="stage s1" id="{{ selected_map }}-stage1">
          <img src="{{ url_for('static', filename='images/stageimg/stage1.png') }}" alt="stage 1">
        </button>
        <button class="stage s2" id="{{ selected_map }}-stage2">
          <img src="{{ url_for('static', filename='images/stageimg/stage2.png') }}" alt="stage 2">
        </button>
        <button class="stage s3" id="{{ selected_map }}-stage3">
          <img src="{{ url_for('static', filename='images/stageimg/stage3.png') }}" alt="stage 3">
        </button>
      </div>

    
    
      <div class="stars">
        <img src="{{ url_for('static', filename='images/stageimg/star-empty.png') }}" class="star st1" />
        <img src="{{ url_for('static', filename='images/stageimg/star-empty.png') }}" class="star st2" />
        <img src="{{ url_for('static', filename='images/stageimg/star-empty.png') }}" class="star st3" />
      </div>
    
      <!-- Reward Bubble inside map-img -->
      <div id="rewardBubble" class="reward-bubble hidden">
        <div class="bubble-content">
          <img id="rewardImage" src="" alt="reward" class="reward-img" />
          <button id="rewardOkButton" class="reward-btn">OK</button>
        </div>
      </div>
    </div>
    
  </div>
  

  <script>
    const selectedMap = "{{ selected_map or '' }}";

    // Function to navigate to the stage
    function goToStage(stageNumber) {
      if (selectedMap) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.style.position = 'fixed';
        loadingOverlay.style.top = '0';
        loadingOverlay.style.left = '0';
        loadingOverlay.style.width = '100vw';
        loadingOverlay.style.height = '100vh';
        loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        loadingOverlay.style.display = 'flex';
        loadingOverlay.style.justifyContent = 'center';
        loadingOverlay.style.alignItems = 'center';
        loadingOverlay.style.color = '#fff';
        loadingOverlay.style.fontSize = '2rem';
        loadingOverlay.style.zIndex = '9999';
        loadingOverlay.innerText = 'Loading...';

        document.body.appendChild(loadingOverlay);

        setTimeout(() => {
          window.location.href = `/game?map=${selectedMap}&stage=${stageNumber}`;
        }, 1000); // 1 second delay
      } else {
        alert('No map selected.');
      }
    }

    // Attach event listeners to stage buttons
    document.querySelectorAll('.stage').forEach((stageImg, index) => {
      stageImg.addEventListener('click', () => {
        goToStage(index + 1); // index 0 => Stage 1, etc.
      });
    });

    // Change background image based on selectedMap
    const mapImgDiv = document.querySelector('.map-img');
    const mapImages = {
      addition: "{{ url_for('static', filename='images/stageimg/addition-bg.png') }}",
      subtraction: "{{ url_for('static', filename='images/stageimg/subtraction-bg.png') }}",
      multiplication: "{{ url_for('static', filename='images/stageimg/multiplication-bg.png') }}",
      division: "{{ url_for('static', filename='images/stageimg/division-bg.png') }}",
      counting: "{{ url_for('static', filename='images/stageimg/counting-bg.png') }}",
      comparison: "{{ url_for('static', filename='images/stageimg/comparison-bg.png') }}",
      numerals: "{{ url_for('static', filename='images/stageimg/numerals-bg.png') }}",
      placevalue: "{{ url_for('static', filename='images/stageimg/placevalue-bg.png') }}"
    };

    if (selectedMap && mapImgDiv) {
      mapImgDiv.style.backgroundImage = `url('${mapImages[selectedMap]}')`;
      mapImgDiv.style.backgroundSize = 'cover';
      mapImgDiv.style.backgroundPosition = 'center';
    }
</script>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const selectedMap = "{{ selected_map or '' }}";
    //================CONNECTION > DATABASE==========================//
    const stageProgress = JSON.parse(localStorage.getItem('stageProgress')) || {};

    const starFilled = "{{ url_for('static', filename='images/stageimg/star-filled.png') }}";  // Filled star
    const starEmpty = "{{ url_for('static', filename='images/stageimg/star-empty.png') }}";   // Empty star

    // Check if we have progress data for the selected map
    if (selectedMap) {
      let allStagesCompleted = true;

      // Loop through the stages (Stage 1, 2, 3) and check the stars
      for (let stage = 1; stage <= 3; stage++) {
        const stageKey = `${selectedMap}-${stage}`;
        const stageData = stageProgress[stageKey];
        const stars = stageData ? stageData.stars : 0; // Default to 0 stars if not set

        const starElements = document.querySelectorAll(`.st${stage}`);
        for (let i = 0; i < starElements.length; i++) {
          if (i < stars) {
            starElements[i].src = starFilled;
          } else {
            starElements[i].src = starEmpty;
          }
        }

        if (stars === 0) {
          allStagesCompleted = false;
        }
      }

      // Check if Stage 3 is completed and if the reward bubble has not been shown before for this map
      const stage3Key = `${selectedMap}-3`;
      const stage3Data = stageProgress[stage3Key];
      const rewardBubbleShownKey = `rewardBubbleShown-${selectedMap}`; // Unique key per map

      //================CONNECTION > DATABASE==========================//
      const rewardBubbleShown = localStorage.getItem(rewardBubbleShownKey) === 'true'; // Check if it's already shown for this map

      if (stage3Data && stage3Data.stars > 0 && !rewardBubbleShown) {
        console.log("Stage 3 completed! Showing reward bubble.");
        showRewardBubble(selectedMap); // Pass selectedMap to show specific reward
      }
    }
  });
  </script>

<script>
  // Function to show the reward bubble and mark as claimed
  function showRewardBubble(selectedMap) {
    const rewardBubble = document.getElementById('rewardBubble');
    const rewardImage = document.getElementById('rewardImage');
    const rewardOkButton = document.getElementById('rewardOkButton');

    // Set the reward image based on selected map
    const rewardImageUrl = getRewardImage(selectedMap);
    rewardImage.src = rewardImageUrl || " "; // fallback

    // Show the reward bubble
    rewardBubble.classList.remove('hidden');
    rewardBubble.classList.add('visible');

    // Mark as claimed in localStorage
    const rewardKey = `${selectedMap}-stage3-skin`;

    //================CONNECTION > DATABASE==========================//
    localStorage.setItem(rewardKey, 'claimed');

    // Also mark that reward bubble was already shown
    const rewardBubbleShownKey = `rewardBubbleShown-${selectedMap}`;
    //================CONNECTION > DATABASE==========================//
    localStorage.setItem(rewardBubbleShownKey, 'true');

    // OK button to close the bubble
    rewardOkButton.addEventListener('click', closeRewardBubble);
  }

  // Function to close the reward bubble
  function closeRewardBubble() {
    const rewardBubble = document.getElementById('rewardBubble');
    rewardBubble.classList.remove('visible');
    rewardBubble.classList.add('hidden');
  }

  // Function to get the reward image based on the selected map
  function getRewardImage(selectedMap) {
    switch (selectedMap) {
      case 'multiplication':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b1.png') }}";
      case 'addition':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b2.png') }}";
      case 'subtraction':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b3.png') }}";
      case 'division':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b4.png') }}";
      case 'counting':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b5.png') }}";
      case 'comparison':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b6.png') }}";
      case 'numerals':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b7.png') }}";
      case 'placevalue':
        return "{{ url_for('static', filename='images/gameimg/rewardimg/skins/b8.png') }}";
      default:
        return "";
    }
  }
</script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const selectedMap = "{{ selected_map or '' }}";
  const stageProgress = JSON.parse(localStorage.getItem('stageProgress')) || {};

  // Track Stage Completion and Enable/Disable Buttons
  function updateStageLock() {
    const stage1Completed = stageProgress[`${selectedMap}-1`] && stageProgress[`${selectedMap}-1`].stars > 0;
    const stage2Completed = stageProgress[`${selectedMap}-2`] && stageProgress[`${selectedMap}-2`].stars > 0;

    // Stage buttons based on completion
    const stageButtons = document.querySelectorAll('.stage');

    stageButtons.forEach(button => {
      const stageId = button.closest('button') ? button.closest('button').getAttribute('id') : null;

      // Check if the button has a valid id
      if (stageId && stageId.startsWith(selectedMap)) {
        const stageNumber = parseInt(stageId.split('-')[1].replace('stage', ''));

        if (stageNumber === 2 && !stage1Completed) {
          // Stage 2 is locked
          button.closest('button').style.filter = 'grayscale(100%)';
          button.closest('button').style.pointerEvents = 'none';
        } else if (stageNumber === 3 && !stage2Completed) {
          // Stage 3 is locked
          button.closest('button').style.filter = 'grayscale(100%)';
          button.closest('button').style.pointerEvents = 'none';
        } else {
          // Stage is unlocked
          button.closest('button').style.filter = 'none';
          button.closest('button').style.pointerEvents = 'auto';
        }
      } else {
        console.warn(`Invalid stage id: ${stageId}`);
      }
    });
  }

  // Hover effect using JS instead of CSS
  const stageElements = document.querySelectorAll('.stage');
  
  stageElements.forEach(stage => {
    stage.addEventListener('mouseover', () => {
      stage.style.transform = 'scale(1.01)'; // Slight zoom on hover
      stage.style.transition = 'transform 0.3s ease'; // Smooth transition
    });

    stage.addEventListener('mouseout', () => {
      stage.style.transform = 'scale(1)'; // Reset scale when hover ends
    });
  });

  updateStageLock(); // Call function to update button states on page load
});

</script>

  





</body>
</html>
